grammar org.mod4j.dsl.presentation.xtext.Presentation with org.eclipse.xtext.common.Terminals

import "platform:/resource/org.mod4j.dsl.presentation.mm/model/PresentationDsl.ecore"

//IMPORTANT: You should change the property 'overwrite.pluginresources=true' in the properties file to 'overwrite.pluginresources=false' AFTER first generation

PresentationModel :
	(description=STRING )?
	"presentation" name = ID ";"
	(externalReferences += ExternalReference)*
	(elements += ModelElementWithContext)*
	;

ExternalReference :
    "from" modelName = ID "import" name = ID ";"
	;
	
ModelElementWithContext :
	UIModelElement //| Link
	;
	
UIModelElement :
	Dialogue | Process
	;
		
Dialogue :
	ContentForm | CompoundDialogue
	;
	
ContentForm :
	(description=STRING )?
    "ContentForm"
	
	 name = ID "context" (collectionContext ?= "list")? contextRef = [ExternalReference]
	"["
		("readonly" ((readonly?="true") | "false") ";")?
		(formElements += FormElement)*
		("actions" "[" (actions += Action ";" )* "]" )?
		("processes" "[" (processes += ProcessCallFromForm ";")* "]" )?
	"]"
	;

Action  returns Process:
	(description=STRING )? 
    (type=ProcessType)? 
    name=ID 
	(processElements += ActionDialogueCall ) ?
    ;
  	
enum ProcessType :
    NEW = "new" | SAVE = "save" | EDIT = "edit" | DELETE = "delete" | CANCEL = "cancel" |
    REMOVEFROM = "removefrom" | ADDTO = "addto"
;

CompoundDialogue :
	(description=STRING )?
	"CompoundDialogue" name = ID "context" contextRef = [ExternalReference]
	("readonly" ((readonly?="true") | "false") ";")?
	
		("dialogues" "[" (dialogues += DialogueCall ";")* "]" )?
		("processes" "[" (processes += ProcessCall ";")* "]" )?  
		| CollectionDialogue
		| MasterDetail
	
	;
		
CollectionDialogue :
	(description=STRING )?
	"CollectionDialogue" name = ID "context" contextRef = [ExternalReference]
	"["
		("readonly" ((readonly?="true") | "false") ";")?
		("dialogues" "[" (dialogues += DialogueCall ";")* "]" )?
		("processes" "[" (processes += ProcessCall ";")* "]" )?
	"]"
	;
	
MasterDetail :
	(description=STRING )?
	"MasterDetail" name = ID "context" contextRef = [ExternalReference]
	("readonly" ((readonly?="true") | "false") ";")?
	"master" master = DialogueCall ";"
	"detail" detail = DialogueCall ";"
	("processes" "[" (processes += ProcessCall ";")* "]" )?
	;

Process :
	(description=STRING )?
	"Process" name = ID "context" (collectionContext ?= "list")? contextRef = [ExternalReference]
	(root ?= "start")?
	(type=ProcessType)?
	( 
		(  ("step"  "[" (processElements += DialogueCall ";")  "]") )
		   |
		(  ("steps" "[" (processElements += UICall       ";")* "]")  )
	)?
	;
	
FormElement :
	(description=STRING )?
	"element" 
//	("navigate" LinkRef "to")? 
	references = DtoPropertyReference 
	"label" label = ID 
	("readonly" ((readonly?="true") | "false") )?
	";"
	;
	
ActionDialogueCall returns DialogueCall:
    (contextExp = Expression)? "to" name = ID
    ("alias" alias = ID)? 
//    ("(" (arguments += Expression) ("," arguments += Expression)*  ")")?
    ;

DialogueCall :
    ("if" "("  condition = OperationExpression ")")?
    (contextExp = Expression )? "to" name = ID
    ("alias" alias = ID)? 
//    ("(" (arguments += Expression) ("," arguments += Expression)*  ")")?
    ;

Expression :
    ServiceExpression | NavigationExpression | StandardExpression
    ;
   	
ProcessCall :
    ("if" "("  condition = OperationExpression ")")?
    (contextExp = Expression)? 
     name = ID
    ("alias" alias = ID)? 
//    ("(" (arguments += Expression) ("," arguments += Expression)*  ")")?
    ;
    
OperationExpression :
    name = ID;
    
ProcessCallFromForm returns ProcessCall :
//    (contextExp = ContextExpression)? 
     name = ID
    ("alias" alias = ID)? 
//    ("(" (arguments += Expression) ("," arguments += Expression)*  ")")?
    ;

//ContextExpression returns StandardExpression :
//    type = ContextType ;
    
//enum ContextType returns ExpressionType :
//    SELECTION = "selection";

StandardExpression :
    type = ExpressionType;
    
enum ExpressionType :
    ALL = "all" | FIND = "find";

ServiceExpression :
    (name = ID ":")? "service"  serviceName = ID "." serviceMethod = ID
    ;

NavigationExpression :
    (name = ID ":")? (composition ?= "composite")? "navigate" references += AssociationRoleReference  
// TODO: Only single reference for now, should become multiple    ( "." references += AssociationRoleReference ) *
    ;

DtoPropertyReference :
	name = ID
	;

AssociationRoleReference :
	name = ID
	;
	
UICall :
	UIModelElementCall
	;
	
UIModelElementCall :
	"dialogue" DialogueCall | "process" ProcessCall
	;
	