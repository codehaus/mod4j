/*******************************************************************************
 * Copyright (c) 2008 Ordina and committers to Mod4j
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *     Ordina - initial implementation
 *******************************************************************************/
import PresentationDsl;

extension org::mod4j::dslcommon::xtend::generatorutil;
extension org::mod4j::dsl::presentation::mm::helpers::PresentationHelpers;
extension org::eclipse::xtend::util::stdlib::elementprops;

boolean hasDouble(Process process, ProcessType type ):
    (
       process.contentForm.actions.forAll(a | (a != process) implies ( a.type != type) ) 
    ) &&
    process.contentForm.processes.referredProcess().select(p | ! p.collectionContext).forAll(p | p.type != type  ) ;
  
boolean hasDouble(ProcessCall pcall, ProcessType ptype) :
    let process = pcall.referredProcess() :
    ( 
        (
            (! process.collectionContext) implies
                  ((ContentForm)(pcall.owningDialogue)).actions.forAll(a | a.type != ptype)  
        ) &&
       pcall.owningDialogue.processes.referredProcess().remove(process).
            forAll(p | ( p.type == ptype) implies (p.collectionContext != process.collectionContext) ) 
     )
     ;

  
context CollectionDialogue ERROR this.name + " must havce exactly one dialogue of type content form" :
    (this.dialogues.size == 1) 
    &&
    (this.dialogues.first().referredContentForm() != null)
    &&
    (this.dialogues.first().referredContentForm().contextRef == this.contextRef) 
    ;

context Process if this.type == ProcessType::ADDTO
ERROR "An addto process must have exactly one form" :
    (this.processElements.size == 1) &&
    (this.processElements.typeSelect(DialogueCall).size == 1);

context Process if this.type == ProcessType::LINK
    ERROR "A link process must have exactly one form" :
    (this.processElements.size == 1) &&
    (this.processElements.typeSelect(DialogueCall).size == 1);

context Process ERROR "A save action / process cannot have a form attached to it" :
    (this.type == ProcessType::SAVE) implies (this.processElements.typeSelect(DialogueCall).isEmpty) ;
    
context Process ERROR "A delete action / process cannot have a form attached to it" :
    (this.type == ProcessType::DELETE) implies (this.processElements.typeSelect(DialogueCall).isEmpty) ;

context Process ERROR "A removefrom action / process cannot have a form attached to it" :
    (this.type == ProcessType::REMOVEFROM) implies (this.processElements.typeSelect(DialogueCall).isEmpty) ;
   
context Process if (this.type != ProcessType::CUSTOM) && (this.contentForm != null) 
    ERROR "11 A Content Form may have at most one '" + this.type + "' action or process" :
    hasDouble(this, this.type);
    
context Process if this.type == ProcessType::SAVE 
    ERROR "A 'save' process cannot have a 'list'  context ":
    ! this.collectionContext;

context Process if this.type == ProcessType::EDIT 
    ERROR "An 'edit' process cannot have a 'list'  context ":
    ! this.collectionContext;

//context Process if (this.type == ProcessType::EDIT) && (this.contentForm != null) 
//    ERROR "A Content Form may have at most one 'edit' action or process" :
//    this.contentForm.actions.forAll(p | (p != this) implies ( p.type != ProcessType::EDIT) ) &&
//    this.contentForm.processes.referredProcess().forAll(p | p.type != ProcessType::EDIT) ;

context ProcessCall if (this.referredProcess().type != ProcessType::CUSTOM) && (this.owningDialogue != null) 
    ERROR "12 A Content Form may have at most one " + this.referredProcess().type + "' action or process" :
    hasDouble(this, this.referredProcess().type);
/*
context ContentForm ERROR "A Content Form may have at most one 'delete list' action" :
    this.actions.union( this.processes.referredProcess() ).select(e| (e.type==ProcessType::DELETE) && e.collectionContext).size <= 1;

context ContentForm ERROR "A Content Form may have at most one 'delete single object' action" :
    this.actions.union( this.processes.referredProcess() ).select(e| (e.type==ProcessType::DELETE) && (!e.collectionContext) ).size <= 1;

context ContentForm ERROR "A Content Form may have at most one 'remove from list' action" :
    this.actions.union( this.processes.referredProcess() ).select(e| (e.type==ProcessType::REMOVEFROM) && e.collectionContext).size <= 1;

context ContentForm ERROR "A Content Form may have at most one 'remove from single object' action" :
    this.actions.union( this.processes.referredProcess() ).select(e| (e.type==ProcessType::REMOVEFROM) && (!e.collectionContext) ).size <= 1;
*/
context DialogueCall ERROR  "Referred form [" + this.name + "] not found" :
	this.referredContentForm() != null
    ;

context ProcessCall ERROR "Referred process [" + this.name + "] not found" :
	this.referredProcess() != null
    ;

context Process ERROR "Process error " + this.getProperty("ERROR") :
    let result = checkProcess(this) :       
    (result.startsWith("ERROR:") ? ( this.setProperty("ERROR", result)->false ): true )
     ;

context ProcessCall ERROR "ProcessCall error " + this.getProperty("ERROR") :
    let result = checkProcessCall(this) :       
    (result.startsWith("ERROR:") ? ( this.setProperty("ERROR", result)->false ): true )
      ;

context ProcessCall if (this.owningDialogue != null) && (this.referredProcess() != null)
 ERROR "The process [" + this.name + "] must have the same context as the from to which it belongs [" + this.owningDialogue.name + "]" :
    this.owningDialogue.contextRef.name.equalsIgnoreCase(this.referredProcess().contextRef.name);